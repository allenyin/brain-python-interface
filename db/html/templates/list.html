{% load static %}
{% get_static_prefix as STATIC_PREFIX %}
<!DOCTYPE HTML>
<html>
<head>
<title>Task Entries</title>
<link rel="stylesheet" type="text/css" href="{{STATIC_PREFIX}}/resources/css/list.css" />
<script src='{{ STATIC_PREFIX }}resources/js/jquery-1.6.2.min.js' type='text/javascript'></script>
<script src='{{ STATIC_PREFIX }}resources/js/jquery-ui-1.8.16.custom.min.js' type='text/javascript'></script>
<script src='{{ STATIC_PREFIX }}resources/js/list.js' type='text/javascript'></script>
<script type='text/javascript'>
{% autoescape off %}
var genparams = {{gens}};
{% endautoescape %}

function startnew(copyid) {
	if ($("#newentry").length == 0) {
		$("#addbtn").hide();
		html = "<tr id='newentry' class='rowactive'>"+
		"	<td class='colDate'>Now</td>"+
		"	<td class='colSubj'>"+
		"		<select id='subjects'>"+
		"			{% for s in subjects %}<option value='{{s.id}}'>{{ s.name }}</option>"+
		"			{% endfor %}"+
		"		</select>"+
		"	</td>"+
		"	<td class='colTask'>"+
		"		<select id='tasks'>"+
		"			{% for t in tasks %}<option value='{{t.id}}'>{{ t.name }}</option>"+
		"			{% endfor %}"+
		"		</select>"+
		"	</td>"+
		"</tr>";
		if ($("#main tbody tr").length == 0)
			$("#main tbody").append(html);
		else
			$("#main tbody tr").first().before(html);

		var newtask = new TaskEntry(-1);
		//Copy data from another entry
		if (typeof(copyid) != "undefined") {
			$("#subjects option").each(function() {
				if ($("#row"+copyid+" td.colSubj").text() == $(this).html())
					$(this).attr("selected", "selected");
			})
			$("#tasks option").each(function() {
				if ($("#row"+copyid+" td.colTask").text() == $(this).html())
					$(this).attr("selected", "selected");
			})
			newtask.activate(copyid);
		} else {
			newtask.activate();
		}
		entries.push(newtask)
	}
}

TaskEntry.prototype.activate = function(idx) {
	$("#content").hide()
	for (var i in entries) {
		entries[i].deactivate();
	}
	
	this.tr.addClass("active rowactive");
	$("#content").addClass("active");
	if (this.running)
		$("#content").addClass("running");
	var status = this.running ? "stop" : "start";
	var btnname = "S"+status.substr(1)+" Experiment";
	var html = "<form id='experiment'>";
	html += "	{% csrf_token %}";
	html += "	<div class='options'></div>";
	html += "	<div class='rightside'></div>";
	html += "	<input id='copybtn' type='button' onclick='startnew("+this.idx+")' value='Copy parameters' />";
	html += "	<input id='startbtn' class='startbtn' type='button' value='"+btnname+"' onclick='"+status+"_experiment()' />";
	html += "	<input id='testbtn' class='startbtn' type='button' value='Test' onclick='test_experiment()' />";
	html += "	<div class='clear'></div>";
	html += "</form>";
	$("#content").html(html);

	this._add_fieldset("Sequence", "options");
	this._add_fieldset("Features", "options");
	this._add_fieldset("Parameters", "options");
	this._add_fieldset("Report", "rightside");
	this._add_fieldset("Notes", "rightside");

	var html = "";
	$("#notes").append("<textarea name='notes'></textarea>")
	$("#parameters").append("<ul></ul>")
	$("#features").append("<ul></ul>")
	{% for name, desc in feats.items %}html += "<li title='{{desc}}'>\n"+
		"	<input type='checkbox' name='{{name}}' id='{{name}}'/>\n"+
		"	<label for='{{name}}'>{{name}}</label>\n"+
		"</li>\n";
	{% endfor %}
	$("#features ul").append(html);

	if (typeof(idx) != "undefined") {
		this.populate(idx, false);
		$("#content .startbtn").show();
		var _this = this;
		$("#features input").change(function() { 
			_this._query_params($("#tasks option").filter(":selected").text());	
		});
	} else if (this.newentry) {
		var _this = this;
		this._query_params($("#tasks option").filter(":selected").text());
		$("#features input").change(function() { 
			_this._query_params($("#tasks option").filter(":selected").text());	
		});
		this.sequence = new SequenceEditor();
		$("#content .startbtn").show();
	} else {
		if (this.running)
			$("#content .startbtn").show();
		this.populate(this.idx);
		$("#copybtn").show()
	}
}

</script>
</head>
<body>
	<div id='leftpane'>
		<table id='main'>
			<thead>
			<tr><th class='colDate'>Date</th><th class='colSubj'>Who</th><th class='colTask'>Task</th></tr>
			</thead>
			<tbody>
			{% for e in entries %}
				<tr id='row{{e.id}}' {% if e.id == running %} class='running' {% endif %}>
				<td class='colDate'>{{e.date}}</td>
				<td class='colSubj'>{{e.subject.name}}</td>
				<td class='colTask'>{{e.task.name}}</td></tr>
			{% endfor %}
			</tbody>
		</table>
		<input id='addbtn' type='button' value='Add new entry' onclick='startnew()' />
	</div>
	<div id="rightpane">
		<div id='content'>
		</div>
	</div>
</body>
</html>