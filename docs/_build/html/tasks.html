<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Creating tasks &mdash; BMI3D 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="BMI3D 1.0 documentation" href="index.html" />
    <link rel="next" title="Experiment extensions" href="extensions.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="extensions.html" title="Experiment extensions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">BMI3D 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="creating-tasks">
<span id="tasks"></span><h1>Creating tasks<a class="headerlink" href="#creating-tasks" title="Permalink to this headline">¶</a></h1>
<p>The definition of a task class contains a set of states and the rules for moving between those states, a set of parameters (both hard-coded and user-defined), state methods (which specify what happens during each state), and transition methods (which specify the conditions for changing states). Every task is a subclass of the <tt class="xref py py-class docutils literal"><span class="pre">Experiment</span></tt> class.</p>
<div class="section" id="defining-the-finite-state-machine-fsm">
<h2>Defining the finite state machine (FSM)<a class="headerlink" href="#defining-the-finite-state-machine-fsm" title="Permalink to this headline">¶</a></h2>
<p>A state can be thought of as a discrete part of the task which is triggered by some condition being met and ends when some other condition is met (i.e. waiting for fixation, or a target hold). The state transition definition describes the structure of the task. For each possible state it lists all the possible subsequent states and the events that trigger those transitions.</p>
<p>For example, the parent class <tt class="xref py py-class docutils literal"><span class="pre">Experiment</span></tt> has the following structure, where ovals represent states and arrows represent transitions:</p>
<img alt="_images/states.png" src="_images/states.png" />
<p>A state transition definition is written in the code as a nested dictionary with the name <tt class="docutils literal"><span class="pre">status</span></tt> that delineates all possible event-next state transitions that could occur from within each state. It is usually the very first thing defined in a task class. For the task illustrated above, the state transition definition in the code looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">status</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">start_trial</span><span class="o">=</span><span class="s">&quot;trial&quot;</span><span class="p">,</span> <span class="n">premature</span><span class="o">=</span><span class="s">&quot;penalty&quot;</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
        <span class="n">trial</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">correct</span><span class="o">=</span><span class="s">&quot;reward&quot;</span><span class="p">,</span> <span class="n">incorrect</span><span class="o">=</span><span class="s">&quot;penalty&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="s">&quot;penalty&quot;</span><span class="p">),</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">post_reward</span><span class="o">=</span><span class="s">&quot;wait&quot;</span><span class="p">),</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">post_penalty</span><span class="o">=</span><span class="s">&quot;wait&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>There are four states in this task (<em>wait</em>, <em>trial</em>, <em>reward</em>, and <em>penalty</em>). Each state name is entered in the <tt class="docutils literal"><span class="pre">status</span></tt> dictionary as a key with another dictionary for the value. That dictionary in turn contains keys which are the names of events that trigger state transitions (they can also be thought of as tests that must be passed in order to move to the next state), and values which are the names of the states that follow these events. So while this task is in the <em>wait</em> state, it can do one of four things at any moment: if the <em>start_trial</em> test is passed, it transitions to the <em>trial</em> state; if the <em>premature</em> test is passed, it transitions to the <em>penalty</em> state; if the experiment receives a stop signal from the server, the task ends; if none of these things occur, it remains in the <em>wait</em> state.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The key/value pair <tt class="docutils literal"><span class="pre">stop</span> <span class="pre">=</span> <span class="pre">None</span></tt> can be inserted into any state where you would like the server to be able to stop the task immediately. If a state&#8217;s dictionary does not contain this entry and a stop command is received, the task will continue until it reaches a state that does contain it. Make sure at least one state has an exit transition, otherwise you will not be able to stop execution of your task!</p>
</div>
</div>
<div class="section" id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h2>
<p>A task class&#8217; methods determine the behavior within each state and the criteria for triggering state transitions. There are five types of special methods:</p>
<p><strong>__init__</strong></p>
<p>Every task has an <em>__init__</em> method that contains actions to be performed once when the task is first run:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#initialize and create fixation point object</span>
<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">FixationTraining</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fixation_point</span> <span class="o">=</span> <span class="n">Sphere</span><span class="p">(</span><span class="n">radius</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>If no initialization steps are necessary for the task, the <em>__init__</em> method can be omitted (because it will automatically inherit the parent <em>__init__</em> method). This is true of the other special methods as well; however, if an <em>__init__</em> method is included, it MUST contain a call to the parent method, whereas the rest of the special methods may be written to replace the parent methods if desired.</p>
<p><strong>_start_</strong></p>
<p><em>_start_</em> methods specify actions to be performed once at the onset of a new state:</p>
<dl class="docutils">
<dt>def _start_wait(self):</dt>
<dd>super(TargetCapture, self)._start_wait()
#set target color
self.origin_target.color = (1,0,0,.5)
#hide target from previous trial
self.origin_target.detach()
self.requeue()</dd>
</dl>
<p>In the above example, every time the task enters the <em>wait</em> state, the origin target&#8217;s color changes and the target is hidden from the screen, in addition to whatever actions are already performed by the parent class&#8217; <em>_start_wait</em> method.</p>
<p>The full name of the method should always be the <tt class="docutils literal"><span class="pre">_start_</span></tt> prefix followed by a state name that appears in the state transition definition, and the method should take <tt class="docutils literal"><span class="pre">self</span></tt> as its sole argument. (These two rules apply to <em>_while_</em> and <em>_end_</em> methods as well.)</p>
<p><strong>_while_</strong></p>
<p><em>_while_</em> methods specify actions to be repeated (usually once per frame) while the task is in a state. Here, the cursor position is being constantly updated during the <em>wait</em> state:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_while_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_cursor</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>_end_</strong></p>
<p><em>_end_</em> methods specify actions to be performed once at the end of a state, just before the task transitions to the next state. In this example, the origin target changes color once a target hold is complete:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_end_origin_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c">#change target color</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">origin_target</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>_test_</strong></p>
<p><em>_test_</em> methods define the criteria for state transitions. They are called constantly in the background during corresponding states, and must always return a boolean value. When a <em>_test_</em> method returns <tt class="docutils literal"><span class="pre">True</span></tt>, a transition to the state specified in the state transition definition is triggered. <em>_test_</em> methods must be named with the prefix <tt class="docutils literal"><span class="pre">_test_</span></tt> followed by one of the event names listed in the state transition definition, and they always have two arguments: <tt class="docutils literal"><span class="pre">self</span></tt> and <tt class="docutils literal"><span class="pre">ts</span></tt>, which is a variable containing the elapsed time in seconds since the onset of the current state. The following <em>_test_</em> method returns <tt class="docutils literal"><span class="pre">True</span></tt> when the elapsed time in the current state (<em>origin_hold</em>) exceeds the constant value <em>origin_hold_time</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_test_hold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin_hold_time</span>
</pre></div>
</div>
<p><strong>_cycle</strong>
TODO</p>
</div>
<div class="section" id="parameters-runtime-configuration">
<h2>Parameters &amp; Runtime configuration<a class="headerlink" href="#parameters-runtime-configuration" title="Permalink to this headline">¶</a></h2>
<p>Parameters which you want to be set by the experimenter at runtime can be defined as <a class="reference external" href="http://code.enthought.com/projects/traits/">Traits</a> within the task class definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># settable traits</span>
<span class="n">reward_time</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Length of juice reward&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument is the default value for the trait and the second is a docstring that will show up when the mouse hovers over that parameter in the web interface. The name of the variable will be the text the user sees in the list of parameters (in this case <tt class="docutils literal"><span class="pre">reward_time</span></tt>).</p>
<p><strong>&#8220;Instance&#8221; traits</strong></p>
<p>traits.Instance-type traits are used for selecting the Decoder. They are useful when the datatype of the thing you want to select is represented by some custom class and you want to be able to select directly from a list of objects. In the current implementation, the object type (e.g., riglib.bmi.Decoder) must correspond to a database model (e.g., models.Decoder). A drop-down list in the GUI is populated with recently created models.Decoder instances. This association is made through db.namelist.instance_to_model. When data from the GUI is submitted back to the server, the object corresponding to the database record is retreived (db.json_param.norm_trait).</p>
<p><strong>&#8220;Enum&#8221; traits</strong></p>
<p>Enum traits provide an alternative way to Instance traits to create a drop-down menu of options on the web interface. If you wish to add an Enum attribute ATTR to a task, you must also specify ATTR_options as a list of string options to select from. This is due to a deficiency in the way traits.Enum objects are created in the version of traits currently being used; there appears to be no way to extract the possible traits from the Enum object.</p>
</div>
<div class="section" id="saving-task-data">
<h2>Saving task data<a class="headerlink" href="#saving-task-data" title="Permalink to this headline">¶</a></h2>
<p>Two types of data saving are currently supported:
1) Saving a variable which could change on every clock tick of the FSM
2) Saving a static variable</p>
<p>Variables you wish to save every FSM iteration must be declared prior to starting the task. The base experiment class has an attribute &#8216;dtype&#8217;, and each new variable to save must be added to this list using the experiment.Experiment.add_dtype method.</p>
<p>To actually save the variable (suppose your variable is named &#8216;data&#8217;), sometime during the execution of the &#8216;_cycle&#8217; method of your task, you must do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">task_data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_value</span>
</pre></div>
</div>
<p>Important note: in child classes, you must do this <em>before</em> calling the &#8216;super&#8217; _cycle method to ensure that your data is saved properly. This is because the final _cycle in the method resolution order is the experiment.Experiment._cycle method, which will send your task_data to any registered sinks. So if you do not set the variable beforehand, it may appear as the data you have saved to file is off by one timestep.</p>
</div>
</div>
<div class="section" id="extending-tasks-with-features">
<h1>Extending tasks with &#8220;features&#8221;<a class="headerlink" href="#extending-tasks-with-features" title="Permalink to this headline">¶</a></h1>
<p>Features are partial tasks which can be used to extend a &#8220;base&#8221; task using multiple inheritance.</p>
<p><a class="reference internal" href="#tasks"><em>Creating tasks</em></a></p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Creating tasks</a><ul>
<li><a class="reference internal" href="#defining-the-finite-state-machine-fsm">Defining the finite state machine (FSM)</a></li>
<li><a class="reference internal" href="#methods">Methods</a></li>
<li><a class="reference internal" href="#parameters-runtime-configuration">Parameters &amp; Runtime configuration</a></li>
<li><a class="reference internal" href="#saving-task-data">Saving task data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extending-tasks-with-features">Extending tasks with &#8220;features&#8221;</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="extensions.html"
                        title="next chapter">Experiment extensions</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tasks.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="extensions.html" title="Experiment extensions"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             >previous</a> |</li>
        <li><a href="index.html">BMI3D 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, James Gao.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>